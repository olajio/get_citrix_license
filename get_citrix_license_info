import subprocess
import re

def get_citrix_license_info():
    # Define the path to lmstat.exe
    lmstat_path = r'C:\Program Files (x86)\Citrix\Licensing\LS\lmstat.exe'
    
    # Execute the lmstat command
    try:
        result = subprocess.run(
            [lmstat_path, '-c', '@localhost', '-a'],
            capture_output=True,
            text=True,
            check=True
        )
    except subprocess.CalledProcessError as e:
        print(f"Error executing lmstat: {e}")
        return None

    output = result.stdout

    # Initialize variables
    total_licenses = used_licenses = free_licenses = None
    expiry_date = None

    # Split the output into lines for processing
    lines = output.splitlines()
    for i, line in enumerate(lines):
        if 'Users of XDT_PLT_CCS' in line:
            # Extract total and used licenses
            match = re.search(r'Total of (\d+) licenses issued; *Total of (\d+) licenses in use', line)
            if match:
                total_licenses = int(match.group(1))
                used_licenses = int(match.group(2))
                free_licenses = total_licenses - used_licenses

            # Look ahead for the expiry date in the next few lines
            for j in range(i+1, min(i+5, len(lines))):
                if 'XDT_PLT_CCS' in lines[j]:
                    expiry_match = re.search(r'expiry:\s*(\S+)', lines[j])
                    if expiry_match:
                        expiry_date = expiry_match.group(1)
                    break
            break

    # Return the extracted information
    return {
        'Total Licenses': total_licenses,
        'Used Licenses': used_licenses,
        'Free Licenses': free_licenses,
        'Expiry Date': expiry_date
    }

# Example usage
if __name__ == "__main__":
    license_info = get_citrix_license_info()
    if license_info:
        for key, value in license_info.items():
            print(f"{key}: {value}")
    else:
        print("Failed to retrieve license information.")
